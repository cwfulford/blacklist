#!/bin/bash
# $Id: blacklist,v 1.108 2018/06/01 11:40:55 fulford Exp $
# $Source: /src/admin/usr/local/etc/RCS/blacklist,v $
# $Revision: 1.108 $
# Author C W Fulford.
# Copyright 2017 (c) C W Fulford.
# Licensed for public use under the LGPL, .
# For assistance contact fulford@fulford.net 0793 572 8612
########################################################################
cmd=`basename $0`

config=/usr/local/etc/blacklist.cf
ver=`echo "$Id: blacklist,v 1.108 2018/06/01 11:40:55 fulford Exp $"|awk '{print $3,$4,$5}'`
sysadmin=fulford@fulford.net

syntax="$cmd  [-l] | [-V]"
while [ $# -gt 0 ] ;do
	case $1 in 
		-l) log=:;shift;;			
		-V) echo "$cmd $Revision: 1.108 $ $Date: 2018/06/01 11:40:55 $"|awk '{print $1,$3,$6}';exit;;  
	esac
done
export ADMINHOST=admin
MAILHOST=mail
export LOG=/var/log/blacklist/blacklist.log
export TARGET=access
export SRCDIR=/src/admin/etc/mail
# CityLinux keeps RCS records of critical files in separate file system 
export TARGETDIR=/etc/mail
export SRC=$SRCDIR/$TARGET
export DEST=$TARGETDIR/$TARGET
TMP=/tmp/${TARGET}

address=`grep "^Return-Path: " | sed -e 's/Return-Path: <\([^>]*\)>/\1/'`
echo "address = $address"

domain=`echo $address|sed -e 's/[^@]*@\(.*$\)/\1/g'`
echo "domain = $domain"

# Spare legitimate domains 
access=`awk <$config '{printf "%s ",$1}'`
if echo $address |grep -s fulford.net; then
	mailx -s "blacklist ALERT" $sysadmin <<- .
		Blackist has found fulford.net in the Return-Path
		$address
	.
	echo "Blacklist has found fulford.net in the Return-Path:"
fi
blacklist=$domain
for d in $access ;do
 	if [ "$domain" == $d ] ;then
		blacklist=$address
	fi
done
echo -n "Blacklist ${blacklist} [y/n]? "
read answer <&2 
answer=${answer:-"y"}
if [ "$answer" == "y" ];then
	
	blacklist=`echo $blacklist|sed -e 's/\(.*\)/\1\t REJECT/'|tee $TMP`
	
	
	# The script will be running with the daemon id, ensure daemon has RCS
	# access to the source file eg. "rcs -a daemon access"
	id	
	ssh $ADMINHOST "
		cd $SRCDIR
		echo \"pwd = `pwd`\"
		echo $ADMINHOST
		hostname	
		co -l -q $TARGET 
		cat $TARGET >>$TMP
		# makemap will fail if there are duplicate entries in the
		# access file
		cat $TMP|sort -u |sudo /usr/bin/dd of=$TARGET  2>/dev/null
		# Ensure sudoers is configured to enable daemon to carry out the
		cat $TARGET|ssh $MAILHOST sudo dd of=$DEST
		/usr/bin/ci -m -q $TARGET
		rm $TMP
		"
	sudo -u fulford ssh $MAILHOST "
		echo "`date`: $blacklist" >>$LOG
		cd $TARGETDIR 
		/usr/bin/make access.db
		set -x
		smpid=`sudo awk 'NR == 1 {print $1}' </var/run/sendmail.pid`
		sudo /bin/kill -1 $smpid 
		logger -t blacklist \"$blacklist blacklisted\"
		"
	
	echo "$blacklist blacklisted."
else
	echo "$blacklist has not been blacklisted."
fi

ssh imap blacklist
echo -n 'Press "Return" to continue'
read ought </dev/tty
