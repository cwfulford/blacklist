#!/bin/bash
# $Id: blacklist,v 1.38 2017/09/05 15:47:32 fulford Exp $
# $Source: /src/admin/usr/local/etc/RCS/blacklist,v $
# $Revision: 1.38 $
# Author C W Fulford.
# Copyright 2017 (c) C W Fulford.
# Licensed for public use under the LGPL, .
# For assistance contact fulford@fulford.net 0793 572 8612
########################################################################
cmd=`basename $0`
ver=`echo "$Id: blacklist,v 1.38 2017/09/05 15:47:32 fulford Exp $"|awk '{print $3,$4,$5}'`
syntax="$cmd  [-l] | [-V]"
while [ $# -gt 0 ] ;do
	case $1 in 
		-l) log=:;shift;;			
		-V) echo "$cmd $Revision: 1.38 $ $Date: 2017/09/05 15:47:32 $"|awk '{print $1,$3,$6}';exit;;  
	esac
done
TARGET=access
SRCDIR=/src/admin/etc/mail
# CityLinux keeps RCS records of critical files in separate file system 
TARGETDIR=/etc/mail
SRC=$SRCDIR/$TARGET
export DEST=$TARGETDIR/$TARGET
cd $SRCDIR
TMP=/tmp/${TARGET}
blacklist=`grep ^Return-Path: |sed -e 's/Return-Path.*@\(.*\)>/\1/g'|
	sed -e 's/\(.*\)/\1\t REJECT/'|
	tee $TMP
`
echo "`date`: $blacklist" >>/var/log/blacklist
# The script will be running with the daemon id, ensure daemon has RCS
# access to the source file eg. "rcs -a daemon access"
sudo -n /usr/bin/co -l -q $TARGET 
sudo /bin/cat $TARGET >>$TMP
# makemap will fail if there are duplicate entries in the access file
cat $TMP|sort -u |sudo /usr/bin/dd of=$TARGET  2>/dev/null
# Ensure sudoers is configured to enable daemon to carry out the exact commands
# as below after the variables have been expanded. 
sudo /bin/cp $TARGET $DEST
sudo /usr/bin/ci -m -q $TARGET
cd $TARGETDIR 
sudo /usr/bin/make access.db 
smpid=`sudo /bin/cat /var/run/sendmail.pid|awk 'NR == 1 {print $1}'`
sudo /bin/kill -1 $smpid 
logger -t blacklist "$blacklist blacklisted"
rm $TMP
